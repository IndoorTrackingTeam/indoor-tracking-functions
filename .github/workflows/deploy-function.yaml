name: Build deploy PROD

on:
  workflow_dispatch:
    inputs:
      manual_deploy:
        description: "Manual Deploy"
        required: true
        type: boolean
        default: true
  push:
    branches:
      - main

env:
  IMAGE: trigger-update-location
  MEMORY: 128Mi
  TIMEOUT: 60
  REGION: us-east1

jobs:
  deploy:
    name: Deploy Cloud Run Job and Scheduler
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - id: 'auth'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Use gcloud CLI
        run: gcloud info

      - name: Login to GCR
        uses: docker/login-action@v1
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      - name: Docker configuration
        run: |-
          gcloud auth configure-docker us-east1-docker.pkg.dev

      - name: Build Docker Image
        run: |-
          docker build \
            --tag "us-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/ar-backend/${{ env.IMAGE }}-prod:latest" \
            ./

      - name: Publish Docker Image to Artifact Registry
        run: |-
          docker push "us-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/ar-backend/${{ env.IMAGE }}-prod:latest"

      - name: Deploy Cloud Run Job
        run: |-
          gcloud run jobs deploy trigger-update-location-job \
            --image "us-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/ar-backend/${{ env.IMAGE }}-prod:latest" \
            --memory $MEMORY \
            --region $REGION \
            --max-retries 3 \
            --timeout $TIMEOUT

      - name: Create Cloud Scheduler Job
        run: |
          gcloud scheduler jobs create http my-scheduler-job \
            --schedule "*/5 * * * *" \
            --uri "https://us-east1-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/${{ secrets.GCP_PROJECT }}/jobs/trigger-update-location-job:run" \
            --http-method POST \
            --oauth-service-account-email ${{ secrets.GCP_SCHEDULER_SA_EMAIL }} \
            --time-zone "America/Sao_Paulo" \
          || echo "Scheduler already exists, updating it..."

      - name: Update Cloud Scheduler Job (if exists)
        run: |
          gcloud scheduler jobs update http my-scheduler-job \
            --schedule "*/5 * * * *" \
            --uri "https://us-east1-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/${{ secrets.GCP_PROJECT }}/jobs/trigger-update-location-job:run" \
            --http-method POST \
            --oauth-service-account-email ${{ secrets.GCP_SCHEDULER_SA_EMAIL }} \
            --time-zone "America/Sao_Paulo"
